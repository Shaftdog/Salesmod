{
  "decisions": [
    {
      "date": "2025-12-10",
      "context": "Research card execution timing out on Vercel with FUNCTION_INVOCATION_TIMEOUT",
      "decision": "Export maxDuration=300 directly from route.ts file, not vercel.json",
      "rationale": "vercel.json 'functions' config does NOT work for Next.js App Router. Must use route segment config (export const maxDuration)"
    },
    {
      "date": "2025-12-10",
      "context": "Need to handle future-dated tasks from research recommendations",
      "decision": "Added 'scheduled' state to kanban cards with due_at field and auto-promotion scheduler",
      "rationale": "Separates immediate actions from future follow-ups. Scheduler promotes to 'suggested' when due_at <= now"
    },
    {
      "date": "2025-12-10",
      "context": "Apollo.io phone reveal requiring webhook",
      "decision": "Disabled reveal_phone_number in Apollo API calls",
      "rationale": "Apollo requires webhook_url for phone number reveals on some plans. Focus on email enrichment instead"
    },
    {
      "date": "2025-12-09",
      "context": "Agent duplicate card spam - research on same client 5+ times per day",
      "decision": "Changed research activity_type from 'note' to 'research' and expanded calculateLastContactDays() to include all engagement types",
      "rationale": "Activity-based timing logic only counted email/call/meeting, making research invisible to the 'smart timing' feature"
    },
    {
      "date": "2025-12-09",
      "context": "Jobs not producing cards after multi-tenant migration",
      "decision": "Pass tenant_id directly to getTargetContacts() instead of looking it up from org_id via profiles",
      "rationale": "Looking up tenant from org_id is fragile and can fail. Jobs table has tenant_id, use it directly"
    },
    {
      "date": "2025-12-09",
      "context": "Learning rules capped at exactly 20 despite having 59 in database",
      "decision": "Fetch card_feedback memories separately with dedicated 100 limit instead of sharing 50 limit with all memory types",
      "rationale": "Shared memory limit was silently truncating card_feedback rules, breaking agent learning"
    }
  ],
  "improvements": [
    {
      "date": "2025-12-18",
      "area": "Order Detail Page",
      "change": "Added property relation to order queries, display property with PropertyChip, use same PropertyMap as Property page",
      "impact": "Order detail page now shows linked property with address, verification badge, and interactive map with satellite toggle"
    },
    {
      "date": "2025-12-16",
      "area": "Production Board",
      "change": "Added Edit Team dialog to production card modal for editing role assignments post-creation",
      "impact": "Users can now reassign Appraiser, Reviewer, Admin, Trainee, Researchers, Inspector after card is created"
    },
    {
      "date": "2025-12-16",
      "area": "My Tasks Page",
      "change": "Added order_number and property_address display to task cards",
      "impact": "Users can see which property/order each task belongs to without opening the card"
    },
    {
      "date": "2025-12-16",
      "area": "Task Assignment",
      "change": "Added TaskAssigneePopover to production card modal for reassigning individual tasks",
      "impact": "Tasks can be reassigned to different team members directly from the Kanban board"
    },
    {
      "date": "2025-12-10",
      "area": "Contact Enrichment",
      "change": "Added Apollo.io integration for verified email addresses during research",
      "impact": "Contacts found via research now have verified emails instead of scraped/guessed ones"
    },
    {
      "date": "2025-12-10",
      "area": "Task Scheduling",
      "change": "Research actions now auto-schedule based on timeframe: immediate=suggested, short_term=+7d, ongoing=+21d",
      "impact": "Future follow-ups don't clutter immediate action queue"
    },
    {
      "date": "2025-12-10",
      "area": "Contact Visibility",
      "change": "Added 'Verified' (green) and 'Research' (cyan) badges to contact cards",
      "impact": "Users can see which contacts have Apollo-verified emails vs web-scraped data"
    },
    {
      "date": "2025-12-09",
      "area": "Agent Planner Prompt",
      "change": "Added 'Recent Activities (AVOID DUPLICATING)' section per client with timestamps showing hours/days ago",
      "impact": "AI can now SEE what actions were recently taken, not just be told to avoid duplicates"
    },
    {
      "date": "2025-12-09",
      "area": "Activity Tracking",
      "change": "Research cards now log as activity_type: 'research' instead of 'note'",
      "impact": "Research engagements now visible to timing logic, prevents research spam"
    },
    {
      "date": "2025-12-09",
      "area": "Tenant Consolidation",
      "change": "Created scripts to diagnose and fix fragmented tenant memories (check-agent-memories-tenant.js, fix-agent-memories-tenant.js)",
      "impact": "Consolidated 59 memories from 6 duplicate tenants into correct tenant"
    }
  ],
  "patterns": [
    {
      "name": "Vercel Function Timeouts (App Router)",
      "description": "For Next.js App Router, export maxDuration directly from route.ts. vercel.json 'functions' config is ignored. Research tasks need 300s due to: web search + Apollo enrichment + AI summarization + action extraction.",
      "files": ["src/app/api/agent/execute-card/route.ts", "src/app/api/agent/run/route.ts"]
    },
    {
      "name": "Database Tags Need UI Components",
      "description": "Tags stored in DB arrays (like contact.tags) are invisible to users until you add UI components to display them. Always add badges/indicators when creating new tag types.",
      "files": ["src/components/contacts/contact-card.tsx"]
    },
    {
      "name": "Scheduled State Pattern",
      "description": "For future-dated actions: 1) Add state to DB constraint, 2) Set due_at timestamp, 3) Create scheduler to promote when due, 4) Call scheduler at start of orchestrator run, 5) Add UI column with due date display.",
      "files": ["src/lib/agent/scheduler.ts", "src/lib/agent/orchestrator.ts", "src/components/agent/kanban-board.tsx"]
    },
    {
      "name": "Apollo API Limitations",
      "description": "Apollo People Enrichment: reveal_phone_number requires webhook_url, linkedin column may not exist in your schema. Focus on email enrichment. Only save contacts that have email OR phone.",
      "files": ["src/lib/research/apollo-enrichment.ts", "src/lib/agent/executor.ts"]
    },
    {
      "name": "Activity Type Visibility",
      "description": "When creating new activity types, ensure they're included in ALL filtering logic that determines engagement - calculateLastContactDays(), getRecentActivities(), engagement scoring, etc.",
      "files": ["src/lib/agent/context-builder.ts", "src/lib/agent/executor.ts"]
    },
    {
      "name": "TypeScript Interface Alignment",
      "description": "When database tables have tenant_id, TypeScript interfaces MUST include tenant_id. Always check interfaces after schema changes.",
      "files": ["src/types/jobs.ts"]
    },
    {
      "name": "Direct Tenant ID Passing",
      "description": "Never look up tenant_id from org_id via profiles. Pass tenant_id directly from the source (job.tenant_id, context.tenantId, etc.).",
      "files": ["src/lib/agent/job-planner.ts"]
    },
    {
      "name": "AI Prompt Visibility",
      "description": "Soft rules in AI prompts ('do not duplicate') are not enough. The AI needs to SEE the data (recent activities, timestamps) to make informed decisions.",
      "files": ["src/lib/agent/planner.ts"]
    },
    {
      "name": "Memory Limit Separation",
      "description": "Different memory scopes need separate limits. card_feedback rules should not compete with chat/classification for a shared limit.",
      "files": ["src/lib/agent/context-builder.ts"]
    },
    {
      "name": "Multi-Tenant Migration Checklist",
      "description": "When migrating org_id to tenant_id: 1) Update TypeScript interfaces, 2) Update all function signatures, 3) Remove profile-based tenant lookups, 4) Consolidate fragmented records, 5) Verify memory/rule associations",
      "files": ["src/types/*.ts", "src/lib/agent/*.ts"]
    },
    {
      "name": "Child Records Need tenant_id",
      "description": "When database functions create child records (tasks from cards, line items from invoices), they MUST copy tenant_id from parent. RLS policies silently filter records without tenant_id, causing 'invisible data' bugs.",
      "files": ["supabase/migrations/*"]
    },
    {
      "name": "PostgreSQL Function Updates",
      "description": "When updating PostgreSQL functions, you may need DROP FUNCTION first if changing return type. Use: DROP FUNCTION IF EXISTS function_name(param_types); before CREATE OR REPLACE.",
      "files": ["scripts/fix-generate-stage-tasks.js"]
    },
    {
      "name": "Database Credentials Location",
      "description": "Database connection strings are in .env.local (DATABASE_URL, DIRECT_DATABASE_URL). Don't hardcode credentials. Session pooler (port 5432) works for migrations, transaction pooler (port 6543) requires tenant info.",
      "files": [".env.local"]
    },
    {
      "name": "Creation-Only vs Editable Fields",
      "description": "When adding fields that users set at creation time (like role assignments), ALSO add edit functionality. Users need to modify these after creation. Check: does the API PUT endpoint support updating this field?",
      "files": ["src/app/api/production/cards/[id]/route.ts"]
    },
    {
      "name": "Safe Date Parsing Pattern",
      "description": "For date-only strings (YYYY-MM-DD), always use: new Date(dateString + 'T00:00:00') to prevent UTC timezone shift. Create parseLocalDate() and formatLocalDate() helpers. Validate with isNaN(date.getTime()). Never use non-null assertion on dates.",
      "files": ["src/components/production/production-card-modal.tsx"]
    },
    {
      "name": "Migration Function Execution",
      "description": "When migrations create setup functions (initialize_defaults, seed_data), the function must be CALLED in the migration or separately executed. Just CREATE FUNCTION is not enough - data won't exist until the function runs.",
      "files": ["supabase/migrations/20251218000000_add_production_sla_config.sql"]
    },
    {
      "name": "CHECK Constraint Alignment",
      "description": "When multiple tables have CHECK constraints for the same enum (like roles), keep them synchronized. If production_tasks supports 8 roles but task_library only allows 4, task creation will fail or fall back incorrectly.",
      "files": ["supabase/migrations/20251218000002_add_researcher_roles_to_task_library.sql"]
    },
    {
      "name": "Universal Date Parsing Pattern",
      "description": "Date parsing must handle multiple formats: 1) Date-only strings (YYYY-MM-DD) from DATE columns - append T00:00:00 for local interpretation, 2) Full ISO timestamps from TIMESTAMPTZ columns - parse and extract UTC components. Check for 'T' in string to determine format.",
      "files": ["src/components/production/production-card-modal.tsx", "src/components/production/kanban-board.tsx", "src/components/production/task-detail-dialog.tsx"]
    },
    {
      "name": "Google Maps with @vis.gl/react-google-maps",
      "description": "1) Use AdvancedMarker, not Marker (deprecated since Feb 2024). 2) mapId can be any string like 'property-map' - doesn't need Google Cloud Console ID for basic use. 3) Map components MUST have explicit height (minHeight or fixed px) - h-full alone won't work if parent height is undefined. 4) Use mapTypeId for roadmap/satellite toggle. 5) gestureHandling='greedy' for full control.",
      "files": ["src/components/properties/property-map.tsx", "src/components/orders/order-map.tsx"]
    },
    {
      "name": "Nested Link Hydration Error",
      "description": "HTML forbids <a> inside <a>. When a component with Link is used inside another Link wrapper (like a card), add disableLink prop to render <span> instead. Error shows as 'In HTML, <a> cannot be a descendant of <a>. This will cause a hydration error.'",
      "files": ["src/components/orders/property-chip.tsx", "src/components/orders/order-card.tsx"]
    },
    {
      "name": "Zod Schemas for URL Query Parameters",
      "description": "URL query parameters are ALWAYS strings. When using Zod schemas to validate them: 1) z.number() will FAIL on '1' (string) - use z.coerce.number() instead, 2) z.boolean() will FAIL on 'true' (string) - use z.preprocess((v) => v === 'true' || v === true, z.boolean()), 3) For JSON request bodies, z.number() and z.boolean() work fine since JSON preserves types.",
      "files": ["src/lib/validations/invoicing.ts", "src/lib/errors/api-errors.ts"]
    },
    {
      "name": "Supabase Relations Must Be Explicitly Selected",
      "description": "Having a foreign key (property_id) does NOT auto-load the relation. Must: 1) Add 'property:properties(*)' to select query, 2) Add transform function (transformProperty), 3) Update parent transform to call it (transformOrder). Check: if order.propertyId exists but order.property is undefined, the relation isn't being fetched.",
      "files": ["src/hooks/use-orders.ts", "src/lib/supabase/transforms.ts"]
    },
    {
      "name": "Narrow Panel Layout Pattern",
      "description": "For components used in narrow panels (side sheets, modals): 1) Avoid horizontal flex with justify-between - buttons get cut off by overflow-hidden. 2) Stack vertically instead (space-y-3). 3) Use w-full on buttons to span available width. 4) shrink-0 alone doesn't prevent clipping if container is narrower than content. 5) Always test in the actual container width, not just in isolation.",
      "files": ["src/components/orders/order-documents-section.tsx"]
    }
  ],
  "last_updated": "2025-12-19",
  "critical_bugs": [
    {
      "date": "2025-12-19",
      "bug": "Invoice pagination breaks entire page - no invoices load",
      "symptom": "After adding pagination parameters (page, limit) to invoice API calls, the page shows 'Loading invoices...' forever or empty table",
      "root_cause": "Zod schema used z.number() for page/limit, but URL query params are strings. Validation failed silently, API returned empty or error.",
      "fix": "Changed PaginationSchema to use z.coerce.number() for page/limit, and z.preprocess() for overdue_only boolean",
      "lesson": "URL query parameters are ALWAYS strings. Use z.coerce.number() instead of z.number(), and z.preprocess() for booleans. Existing code may have latent bugs if the validation path was never exercised.",
      "files": ["src/lib/validations/invoicing.ts"]
    },
    {
      "date": "2025-12-18",
      "bug": "SLA due dates not being set on production tasks",
      "symptom": "Tasks created when card moves to new stage had 'Due Date: Not set' despite SLA configuration existing in migration",
      "root_cause": "Migration created initialize_production_sla_defaults() function but never CALLED it for existing tenants. production_sla_config table was empty.",
      "fix": "1) Run initialize_production_sla_defaults(tenant_id) for each tenant, 2) Backfill existing tasks with UPDATE...SET due_date = calculate_task_due_date(...)",
      "lesson": "Migration functions that SETUP data (defaults, seeds) must be EXECUTED, not just created. Add INSERT statements or call the function in the migration itself.",
      "files": ["supabase/migrations/20251218000000_add_production_sla_config.sql", "init-sla-defaults.js"]
    },
    {
      "date": "2025-12-18",
      "bug": "Due dates showing wrong day (Dec 23 displays as Dec 22)",
      "symptom": "When user enters December 23 as due date, it shows December 22 on the card",
      "root_cause": "JavaScript new Date('2025-12-23') interprets date-only strings as UTC midnight. In US Eastern time (UTC-5), UTC midnight becomes previous day at 7pm local.",
      "fix": "Append T00:00:00 to force local timezone: new Date('2025-12-23T00:00:00') creates local midnight instead of UTC midnight",
      "lesson": "NEVER use new Date() directly on date-only strings (YYYY-MM-DD). Always append 'T00:00:00' or use a parseLocalDate helper function.",
      "files": ["src/components/production/production-card-modal.tsx", "src/components/production/kanban-board.tsx", "src/components/production/task-detail-dialog.tsx"]
    },
    {
      "date": "2025-12-18",
      "bug": "RangeError: Invalid time value when formatting dates",
      "symptom": "Runtime error 'Invalid time value' when opening production card modal",
      "root_cause": "Some task.due_date values were empty strings or malformed. parseLocalDate returned undefined but code used non-null assertion (!) and tried to format it.",
      "fix": "1) Validate parsed date with isNaN(date.getTime()), 2) Create safe formatLocalDate() helper that returns empty string for invalid dates",
      "lesson": "Always validate Date objects before formatting. Use isNaN(date.getTime()) to detect invalid dates. Never use non-null assertion (!) on potentially undefined date values.",
      "files": ["src/components/production/production-card-modal.tsx"]
    },
    {
      "date": "2025-12-18",
      "bug": "Task due dates showing calendar icon but no date text",
      "symptom": "Production card modal showed calendar icons next to tasks but the due date text was blank",
      "root_cause": "task.due_date contained full ISO timestamps (2025-12-23T05:00:00.000Z) from database. parseLocalDate appended 'T00:00:00' creating invalid string '2025-12-23T05:00:00.000ZT00:00:00'",
      "fix": "Check if dateString.includes('T') - if so, parse as ISO and extract UTC date parts; if not, append T00:00:00 for local interpretation",
      "lesson": "Date parsing must handle BOTH date-only strings (YYYY-MM-DD) AND full ISO timestamps. Database columns may return either format depending on type (DATE vs TIMESTAMPTZ).",
      "files": ["src/components/production/production-card-modal.tsx", "src/components/production/kanban-board.tsx", "src/components/production/task-detail-dialog.tsx"]
    },
    {
      "date": "2025-12-16",
      "bug": "Production tasks not showing in Kanban board modal",
      "symptom": "Cards showed '0 of 4 tasks' but task list was empty when clicking on card",
      "root_cause": "generate_stage_tasks function created tasks WITHOUT tenant_id. RLS policy production_tasks_tenant_isolation filtered them out.",
      "fix": "1) Backfill existing tasks with UPDATE...FROM production_cards, 2) Update generate_stage_tasks to include tenant_id in INSERT, 3) Add trigger auto_set_production_task_tenant_id as fallback",
      "lesson": "When creating child records (tasks) from parent records (cards), ALWAYS copy tenant_id. RLS policies silently filter records without proper tenant_id.",
      "files": ["supabase/migrations/20251216000000_fix_production_tasks_tenant_id.sql"]
    },
    {
      "date": "2025-12-16",
      "bug": "Order creation failing with constraint violation",
      "symptom": "Error: 'new row for relation orders violates check constraint orders_status_check'",
      "root_cause": "Order forms used legacy status values ('new', 'pending') but database constraint only allows production stages (INTAKE, SCHEDULING, etc.)",
      "fix": "Changed all order creation forms to use status: 'INTAKE' instead of 'new' or 'pending'",
      "lesson": "When database constraints are updated (like orders_status_check), search entire codebase for hardcoded status values that may now be invalid.",
      "files": ["src/components/orders/order-form.tsx", "src/app/client-portal/orders/new/page.tsx"]
    },
    {
      "date": "2025-12-14",
      "bug": "React Query hook bypassing API endpoint",
      "symptom": "Subtasks returned by API but not showing in UI",
      "root_cause": "useMyProductionTasksToday hook queried Supabase directly, not using the /api/production/my-tasks endpoint that had been updated to fetch subtasks",
      "fix": "Changed hook to use fetch('/api/production/my-tasks') instead of direct Supabase query",
      "lesson": "When updating an API endpoint with new data (subtasks, relations, etc.), ALWAYS check if there's a React Query hook that bypasses the API. Hooks that query Supabase directly will miss API-level enhancements.",
      "files": ["src/hooks/use-production.ts", "src/app/api/production/my-tasks/route.ts"]
    },
    {
      "date": "2025-12-14",
      "bug": "Authorization comparing org_id to user.id",
      "symptom": "403 Forbidden errors on task detail page",
      "root_cause": "Code checked `production_card.org_id !== user.id` but org_id is a tenant identifier, not a user ID",
      "fix": "Get user's tenant_id from profile, then compare: `production_card.org_id === profile.tenant_id`",
      "lesson": "org_id/tenant_id are organization identifiers, NOT user IDs. Authorization must compare tenant_id to tenant_id, not to user.id.",
      "files": ["src/app/api/production/tasks/[id]/route.ts", "src/app/api/production/tasks/[id]/time-entries/route.ts"]
    }
  ],
  "debugging_techniques": [
    {
      "date": "2025-12-14",
      "scenario": "Data returned by API but not rendered in UI",
      "technique": "Use Playwright evaluate() to check if expected text exists in DOM",
      "example": "document.body.textContent.includes('Subtasks') returned false, proving the component wasn't rendering subtasks despite API returning them",
      "next_step": "If DOM doesn't have expected content, trace data flow: API -> React Query hook -> Component props -> Render logic"
    },
    {
      "date": "2025-12-19",
      "scenario": "Button or UI element not visible despite code looking correct",
      "technique": "Use Playwright to test in actual container context, not just check if element exists in DOM",
      "example": "Upload Document button was in DOM (visible in get_visible_text) but cut off by narrow panel overflow. Screenshot and actual user view showed missing button.",
      "next_step": "If element exists in DOM but user can't see it: 1) Check parent overflow-hidden, 2) Test in actual container width, 3) Consider vertical stacking instead of horizontal layout"
    }
  ],
  "anti_patterns": [
    {
      "name": "Dual Data Paths",
      "description": "Having both a React Query hook that queries Supabase directly AND an API endpoint for the same data. When you update one, the other gets stale.",
      "solution": "Use API endpoints consistently. Hooks should call fetch('/api/...') not query Supabase directly. This ensures all enhancements (subtasks, timers, relations) are available to the frontend.",
      "example": "useMyProductionTasksToday was querying Supabase while /api/production/my-tasks had subtask fetching logic"
    }
  ]
}
