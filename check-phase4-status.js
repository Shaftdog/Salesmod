#!/usr/bin/env node

/**
 * Phase 4 Learning System - Status Diagnostic
 *
 * This script checks the current state of the learning system
 * and verifies that all Phase 4 components are functioning.
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Missing Supabase credentials in .env.local');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkPhase4Status() {
  console.log('ğŸ” Phase 4 Learning System - Status Check\n');
  console.log('=' .repeat(60));

  try {
    // Get org ID (assume first user for testing)
    const { data: users, error: userError } = await supabase.auth.admin.listUsers();

    if (userError || !users || users.users.length === 0) {
      console.error('âŒ No users found. Cannot proceed with testing.');
      return;
    }

    const orgId = users.users[0].id;
    console.log(`\nâœ… Testing with user: ${users.users[0].email}`);
    console.log(`   Org ID: ${orgId}`);

    // Check agent_memories table
    console.log('\nğŸ“Š AGENT MEMORIES TABLE');
    console.log('-'.repeat(60));

    const { data: memories, error: memoriesError } = await supabase
      .from('agent_memories')
      .select('*')
      .eq('org_id', orgId)
      .eq('scope', 'card_feedback');

    if (memoriesError) {
      console.error(`âŒ Error fetching memories: ${memoriesError.message}`);
    } else {
      console.log(`âœ… Total feedback entries: ${memories.length}`);

      // Count by type
      const rules = memories.filter(m => m.content?.rule);
      const feedback = memories.filter(m => m.content?.type?.includes('feedback'));
      const autoGenerated = memories.filter(m => m.content?.auto_generated);
      const consolidated = memories.filter(m => m.content?.type === 'consolidated_rule');
      const deprecated = memories.filter(m => m.content?.deprecated);

      console.log(`   - Rules: ${rules.length}`);
      console.log(`   - Raw feedback: ${feedback.length}`);
      console.log(`   - Auto-generated rules: ${autoGenerated.length}`);
      console.log(`   - Consolidated rules: ${consolidated.length}`);
      console.log(`   - Deprecated rules: ${deprecated.length}`);
    }

    // Check kanban_cards table
    console.log('\nğŸ“‹ KANBAN CARDS TABLE');
    console.log('-'.repeat(60));

    const { data: cards, error: cardsError } = await supabase
      .from('kanban_cards')
      .select('state')
      .eq('org_id', orgId);

    if (cardsError) {
      console.error(`âŒ Error fetching cards: ${cardsError.message}`);
    } else {
      console.log(`âœ… Total cards: ${cards.length}`);

      const suggested = cards.filter(c => c.state === 'suggested').length;
      const approved = cards.filter(c => c.state === 'approved').length;
      const completed = cards.filter(c => c.state === 'completed').length;
      const rejected = cards.filter(c => c.state === 'rejected').length;

      console.log(`   - Suggested: ${suggested}`);
      console.log(`   - Approved: ${approved}`);
      console.log(`   - Completed: ${completed}`);
      console.log(`   - Rejected: ${rejected}`);
    }

    // Phase 4.2 - Learning Dashboard readiness
    console.log('\nğŸ§  PHASE 4.2 - LEARNING DASHBOARD');
    console.log('-'.repeat(60));

    if (memories && memories.length > 0) {
      const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      const recentMemories = memories.filter(m => new Date(m.created_at) > last30Days);
      console.log(`âœ… Recent feedback (30 days): ${recentMemories.length}`);

      const { data: recentCards } = await supabase
        .from('kanban_cards')
        .select('state')
        .eq('org_id', orgId)
        .gte('created_at', last30Days.toISOString());

      if (recentCards) {
        const approvalRate = recentCards.length > 0
          ? ((recentCards.filter(c => c.state === 'approved').length / recentCards.length) * 100).toFixed(1)
          : 0;
        console.log(`âœ… Approval rate: ${approvalRate}%`);
      }
    } else {
      console.log('âš ï¸  No feedback data available for dashboard');
    }

    // Phase 4.3 - Rules Management readiness
    console.log('\nâš™ï¸  PHASE 4.3 - RULES MANAGEMENT');
    console.log('-'.repeat(60));

    if (rules && rules.length > 0) {
      console.log(`âœ… Rules available for management: ${rules.length}`);

      const rulesByType = rules.reduce((acc, rule) => {
        const type = rule.content?.card_type || 'unknown';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});

      console.log('   Rules by card type:');
      Object.entries(rulesByType).forEach(([type, count]) => {
        console.log(`   - ${type}: ${count}`);
      });
    } else {
      console.log('âš ï¸  No rules available for management');
    }

    // Phase 4.4 - Automation readiness
    console.log('\nâš¡ PHASE 4.4 - AUTOMATION');
    console.log('-'.repeat(60));

    // Check for auto-rule suggestions (3+ similar feedback)
    if (feedback && feedback.length > 0) {
      const reasonGroups = feedback.reduce((acc, f) => {
        const reason = (f.content?.reason || '').toLowerCase().trim();
        if (reason) {
          acc[reason] = (acc[reason] || 0) + 1;
        }
        return acc;
      }, {});

      const autoRuleCandidates = Object.entries(reasonGroups).filter(([_, count]) => count >= 3);
      console.log(`âœ… Auto-rule candidates (3+ occurrences): ${autoRuleCandidates.length}`);

      if (autoRuleCandidates.length > 0) {
        console.log('   Top patterns:');
        autoRuleCandidates.slice(0, 5).forEach(([reason, count]) => {
          console.log(`   - "${reason}" (${count}x)`);
        });
      }
    } else {
      console.log('âš ï¸  No feedback available for auto-rule detection');
    }

    // Check for consolidation opportunities
    if (rules && rules.length >= 2) {
      console.log(`âœ… Rules available for consolidation analysis: ${rules.length}`);
      console.log('   (System will detect >70% similarity)');
    } else {
      console.log('âš ï¸  Not enough rules for consolidation (need 2+)');
    }

    // Check for deprecation candidates
    if (rules && rules.length > 0) {
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      const oldRules = rules.filter(r => new Date(r.created_at) < thirtyDaysAgo);
      console.log(`âœ… Deprecation candidates (30+ days old): ${oldRules.length}`);
    } else {
      console.log('âš ï¸  No rules available for deprecation analysis');
    }

    // API Endpoints Check
    console.log('\nğŸŒ API ENDPOINTS');
    console.log('-'.repeat(60));

    const endpoints = [
      '/api/agent/learning/dashboard',
      '/api/agent/learning/rules',
      '/api/agent/automation/analyze',
      '/api/agent/automation/execute',
    ];

    console.log('âœ… Expected endpoints:');
    endpoints.forEach(endpoint => {
      console.log(`   - ${endpoint}`);
    });

    // Component Files Check
    console.log('\nğŸ“ COMPONENT FILES');
    console.log('-'.repeat(60));

    const fs = require('fs');
    const path = require('path');

    const components = [
      'src/components/agent/learning-dashboard.tsx',
      'src/components/agent/rules-management.tsx',
      'src/components/agent/automation-dashboard.tsx',
    ];

    components.forEach(comp => {
      const filePath = path.join(process.cwd(), comp);
      if (fs.existsSync(filePath)) {
        console.log(`âœ… ${comp}`);
      } else {
        console.log(`âŒ MISSING: ${comp}`);
      }
    });

    // Summary
    console.log('\n' + '='.repeat(60));
    console.log('ğŸ“Š SUMMARY');
    console.log('='.repeat(60));

    const hasData = memories && memories.length > 0;
    const hasRules = rules && rules.length > 0;
    const hasCards = cards && cards.length > 0;

    if (hasData && hasRules && hasCards) {
      console.log('\nâœ… System is ready for comprehensive testing!');
      console.log('\nğŸ“ Next steps:');
      console.log('   1. Navigate to http://localhost:9002/agent');
      console.log('   2. Click through all 4 tabs (Board, Learning, Rules, Automation)');
      console.log('   3. Follow E2E-PHASE-4-TESTING-GUIDE.md for detailed tests');
      console.log('   4. Test automation suggestions and actions');
    } else {
      console.log('\nâš ï¸  System has limited data for testing');
      console.log('\nğŸ“ Recommendations:');
      if (!hasCards) {
        console.log('   - Run agent to create some cards');
      }
      if (!hasRules) {
        console.log('   - Reject cards to create learning rules');
      }
      if (!hasData) {
        console.log('   - Generate feedback by interacting with cards');
      }
      console.log('   - Once data is available, all features will activate');
    }

    console.log('\nğŸ¯ Test URL: http://localhost:9002/agent');
    console.log('ğŸ“– Testing Guide: E2E-PHASE-4-TESTING-GUIDE.md');
    console.log('');

  } catch (error) {
    console.error('\nâŒ Error during status check:', error.message);
    console.error(error);
  }
}

// Run the check
checkPhase4Status();
