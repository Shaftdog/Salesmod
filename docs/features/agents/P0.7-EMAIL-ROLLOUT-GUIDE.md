---
status: current
last_verified: 2025-12-19
updated_by: Claude Code
---

# P0.7 Email Rollout Controls Guide

This guide covers the email sending configuration, Gmail OAuth integration, and safe rollout controls for the autonomous agent system.

## Overview

The email system supports four send modes with progressive rollout:

| Mode | Description | Actual Send? |
|------|-------------|--------------|
| `dry_run` | Log only, no actual send | No |
| `internal_only` | Send only to approved domains/emails | Yes (filtered) |
| `limited_live` | Send with strict per-tenant rate limits | Yes (rate-limited) |
| `live` | Full production sending | Yes |

## Quick Start

### 1. Environment Variables

```bash
# Email Configuration
EMAIL_SEND_MODE=dry_run          # Override tenant settings (optional)
EMAIL_SEND_DISABLED=false        # Global kill switch
RESEND_API_KEY=re_xxx            # Resend API key

# Gmail OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxx
GOOGLE_REDIRECT_URI=https://yourapp.com/api/auth/google/callback

# Alerting
ALERT_WEBHOOK_URL=https://hooks.slack.com/xxx  # Optional
```

### 2. Database Migration

Run the migration to create required tables:

```bash
npx supabase db push
```

This creates:
- `agent_alerts` - Alert records
- `email_provider_failures` - Provider failure tracking

### 3. Configure Tenant Settings

Update tenant settings via admin or directly:

```sql
UPDATE tenants
SET agent_settings = jsonb_set(
  COALESCE(agent_settings, '{}'),
  '{email_send_mode}',
  '"internal_only"'
)
WHERE id = 'your-tenant-id';
```

## Configuration Options

### Per-Tenant Settings

Stored in `tenants.agent_settings`:

```json
{
  "email_send_mode": "internal_only",
  "internal_email_domains": ["roiappraise.com", "yourdomain.com"],
  "internal_email_addresses": ["specific@external.com"],
  "max_emails_per_hour": 20,
  "max_emails_per_day": 100,
  "from_email": "admin@yourdomain.com",
  "from_name": "Your Company",
  "reply_to_email": "support@yourdomain.com"
}
```

### Default Values

If not configured, defaults are:

```typescript
{
  sendMode: 'dry_run',              // Safe default
  internalDomains: ['roiappraise.com', 'roiappraisalgroup.com'],
  internalEmails: [],
  maxEmailsPerHour: 20,
  maxEmailsPerDay: 100,
  fromEmail: 'admin@roiappraise.com',
  fromName: 'ROI Appraisal Group',
  replyToEmail: 'admin@roiappraise.com',
}
```

## Send Modes Explained

### dry_run Mode

- All emails are logged but never actually sent
- Use for testing email content and flow
- Always returns `simulated: true`

```json
// Response
{
  "success": true,
  "messageId": "sim_dry_run_xxx",
  "simulated": true,
  "mode": "dry_run"
}
```

### internal_only Mode

- Emails only sent to approved domains/addresses
- External addresses blocked and logged
- Rate limits still apply

```typescript
// Approved if:
// 1. Recipient domain is in internalDomains, OR
// 2. Recipient email is in internalEmails
```

### limited_live Mode

- Strict rate limits enforced
- Blocked if hourly limit exceeded
- Use before full production rollout

### live Mode

- Full production sending
- Rate limits still apply but don't block
- Monitor alerts closely

## Gmail OAuth Integration

### Connection Status

The system tracks Gmail connection status:

| Status | Meaning |
|--------|---------|
| `connected` | Active, valid token |
| `token_expired` | Will auto-refresh on next use |
| `revoked` | Token expired and can't refresh |
| `not_configured` | No OAuth token found |
| `needs_auth` | User needs to re-authorize |

### Check Connection Status

```typescript
import { getGmailConnectionStatus } from '@/lib/email/email-config';

const status = await getGmailConnectionStatus(tenantId, userId);
// Returns:
// {
//   status: 'connected',
//   accountEmail: 'user@gmail.com',
//   lastSyncAt: '2025-12-19T10:00:00Z',
//   syncEnabled: true,
//   tokenExpiresAt: '2025-12-20T10:00:00Z'
// }
```

### Token Refresh

Tokens are automatically refreshed when:
1. Token is expired
2. Refresh token exists
3. Google API is available

If refresh fails, status becomes `revoked`.

## Alerting System

### Alert Types

| Type | Severity | Trigger |
|------|----------|---------|
| `email_volume_spike` | warning | 200%+ of normal volume |
| `email_provider_failure` | critical | 5+ failures in 15 min |
| `gmail_quota_exceeded` | warning | Gmail rate limit hit |
| `policy_block_spike` | warning | 10+ blocks in 1 hour |
| `rate_limit_exceeded` | info | Rate limit hit |

### Webhook Notifications

Set `ALERT_WEBHOOK_URL` to receive Slack/webhook notifications:

```json
// Webhook payload
{
  "text": "[CRITICAL] email_provider_failure: Repeated email provider failures",
  "tenantId": "xxx",
  "timestamp": "2025-12-19T10:00:00Z",
  "failureCount": 5,
  "latestError": "Resend API error: 500"
}
```

### Query Alerts

```sql
-- Get recent alerts
SELECT * FROM agent_alerts
WHERE tenant_id = 'your-tenant-id'
  AND created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- Get alert summary
SELECT * FROM get_alert_summary('your-tenant-id', 24);

-- Check provider health
SELECT * FROM check_email_provider_health('your-tenant-id', 15);
```

## Rollout Procedure

### Phase 1: dry_run (Testing)

1. Set `EMAIL_SEND_MODE=dry_run`
2. Trigger email actions
3. Verify emails are logged correctly
4. Check activity records for simulated sends

### Phase 2: internal_only (Internal Testing)

1. Configure internal domains:
   ```sql
   UPDATE tenants SET agent_settings = jsonb_set(
     agent_settings, '{internal_email_domains}',
     '["yourcompany.com", "testdomain.com"]'
   ) WHERE id = 'tenant-id';
   ```
2. Set mode to `internal_only`
3. Send test emails to internal addresses
4. Verify actual delivery
5. Test external blocking

### Phase 3: limited_live (Gradual Rollout)

1. Set `max_emails_per_hour: 10` (low limit)
2. Switch to `limited_live` mode
3. Monitor:
   - Email delivery rates
   - Provider failures
   - Rate limit hits
4. Gradually increase limits

### Phase 4: live (Production)

1. Set `max_emails_per_hour: 100` (or higher)
2. Switch to `live` mode
3. Monitor alerts closely
4. Have rollback plan ready

## Troubleshooting

### Emails Not Sending

1. Check mode: `SELECT agent_settings->>'email_send_mode' FROM tenants WHERE id = 'xxx';`
2. Check global disable: `echo $EMAIL_SEND_DISABLED`
3. Check Resend key: `echo $RESEND_API_KEY`
4. Check rate limits: `SELECT * FROM agent_rate_limits WHERE tenant_id = 'xxx';`

### Gmail Not Syncing

1. Check connection status via API
2. Verify OAuth tokens exist: `SELECT * FROM oauth_tokens WHERE provider = 'google';`
3. Check sync state: `SELECT * FROM gmail_sync_state WHERE tenant_id = 'xxx';`
4. Look for errors: `SELECT * FROM agent_alerts WHERE alert_type = 'gmail_quota_exceeded';`

### High Alert Volume

1. Check alert summary: `SELECT * FROM get_alert_summary('xxx', 24);`
2. Investigate top alert types
3. Consider adjusting thresholds
4. May indicate actual issue (provider problems, etc.)

### Rate Limits Hit

1. Check current usage: `SELECT * FROM agent_rate_limits WHERE tenant_id = 'xxx';`
2. Increase limits if legitimate
3. Check for runaway automation if unexpected

## API Reference

### Send Email

```http
POST /api/email/send
Content-Type: application/json
Authorization: Bearer <token>

{
  "to": "recipient@example.com",
  "subject": "Hello",
  "html": "<p>Email content</p>",
  "text": "Email content",
  "replyTo": "reply@example.com",
  "contactId": "uuid"  // Optional, for suppression check
}
```

### Response

```json
// Success
{
  "success": true,
  "messageId": "re_xxx",
  "simulated": false,
  "mode": "live"
}

// Blocked
{
  "error": "Rate limit exceeded: 20/20 emails/hour",
  "mode": "limited_live",
  "blocked": true
}
```

## Security Considerations

1. **Multi-tenant Isolation**: All queries filtered by tenant_id
2. **Rate Limiting**: Prevents abuse and runaway automation
3. **Suppression Checking**: Respects bounce/complaint suppressions
4. **Kill Switch**: Global disable available via environment variable
5. **Alerting**: Critical issues trigger notifications

## Files Reference

| File | Purpose |
|------|---------|
| `src/lib/email/email-config.ts` | Email configuration service |
| `src/lib/agent/agent-config.ts` | Rate limiting and alerting |
| `src/app/api/email/send/route.ts` | Email send endpoint |
| `supabase/migrations/20251219000000_email_alerting_tables.sql` | Database schema |
