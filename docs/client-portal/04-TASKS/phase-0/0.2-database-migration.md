# Task 0.2: Database Migration Execution

**Phase:** 0 (Multi-Tenant Migration)
**Priority:** P0 (Critical - Blocker for Phase 1)
**Effort:** 8 story points (~1.5 weeks)
**Owner:** Backend Developer + DevOps

---

## References

**Requirements:** N/A (Infrastructure task)
**Architecture:** [02-ARCHITECTURE.md#multi-tenant-strategy](../02-ARCHITECTURE.md#multi-tenant-strategy)
**Roadmap:** [03-ROADMAP.md#phase-0](../03-ROADMAP.md#phase-0)

---

## Objective

Execute the multi-tenant migration on production database:
1. Create tenant records for all existing users
2. Backfill `tenant_id` on 12 tables
3. Update 40+ RLS policies (additive, non-breaking)
4. Verify data integrity

---

## Prerequisites

- [ ] Task 0.1 (Migration Planning) complete
- [ ] Migration scripts tested successfully on staging
- [ ] Rollback procedure documented and tested
- [ ] Production database backup verified
- [ ] Maintenance window scheduled (off-peak: 2-6 AM UTC)
- [ ] Stakeholders notified 48 hours in advance

---

## Implementation Steps

### Step 1: Pre-Migration Checks (30 minutes)

```bash
# 1. Verify backup exists
supabase db backup list

# 2. Check database size
SELECT pg_size_pretty(pg_database_size('postgres'));

# 3. Count records to migrate
SELECT
  'clients' as table_name,
  COUNT(*) as record_count
FROM clients
UNION ALL
SELECT 'orders', COUNT(*) FROM orders
UNION ALL
SELECT 'properties', COUNT(*) FROM properties;
-- ... repeat for all 12 tables

# 4. Verify no ongoing transactions
SELECT * FROM pg_stat_activity
WHERE state = 'active' AND query NOT LIKE '%pg_stat_activity%';
```

**Decision Point:** If active transactions exist, wait or abort.

---

### Step 2: Create Tenants (15 minutes)

```sql
-- Migration: 20251110000001_create_tenants_table_and_backfill.sql

-- Part 1: Create tenants table
CREATE TABLE IF NOT EXISTS public.tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  type TEXT NOT NULL DEFAULT 'internal' CHECK (type IN (
    'lender', 'investor', 'amc', 'attorney', 'accountant', 'borrower', 'internal'
  )),
  owner_id UUID REFERENCES public.profiles(id) NOT NULL,
  theme_settings JSONB DEFAULT '{"primaryColor": "#3b82f6", "logo": null}'::jsonb,
  sla_settings JSONB DEFAULT '{"standard_turnaround_days": 7, "rush_turnaround_days": 3}'::jsonb,
  settings JSONB DEFAULT '{}'::jsonb,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for lookups
CREATE INDEX idx_tenants_owner ON public.tenants(owner_id);

-- Enable RLS
ALTER TABLE public.tenants ENABLE ROW LEVEL SECURITY;

-- RLS policy
CREATE POLICY "Users can view their own tenant"
  ON public.tenants FOR SELECT
  USING (
    id IN (SELECT tenant_id FROM public.profiles WHERE id = auth.uid())
    OR owner_id = auth.uid()
  );

-- Part 2: Create tenant for each existing user
INSERT INTO public.tenants (name, type, owner_id)
SELECT
  COALESCE(p.name || '''s Organization', 'Organization'),
  'internal',
  p.id
FROM public.profiles p
WHERE NOT EXISTS (SELECT 1 FROM public.tenants WHERE owner_id = p.id)
ON CONFLICT DO NOTHING;

-- Verify
SELECT COUNT(*) as tenants_created FROM public.tenants;
-- Should match number of users
```

**Validation:**
```sql
-- Check: Every user should have a tenant
SELECT COUNT(*) as users_without_tenant
FROM profiles p
WHERE NOT EXISTS (SELECT 1 FROM tenants WHERE owner_id = p.id);
-- Should be 0
```

---

### Step 3: Add tenant_id to profiles (10 minutes)

```sql
-- Add column
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS tenant_id UUID REFERENCES public.tenants(id);

-- Backfill
UPDATE public.profiles p
SET tenant_id = t.id
FROM public.tenants t
WHERE t.owner_id = p.id
AND p.tenant_id IS NULL;

-- Add index
CREATE INDEX idx_profiles_tenant ON public.profiles(tenant_id);

-- Verify
SELECT COUNT(*) as profiles_without_tenant
FROM profiles
WHERE tenant_id IS NULL;
-- Should be 0
```

---

### Step 4: Backfill tenant_id on all tables (60 minutes)

**Tables to migrate (12 total):**
1. clients
2. orders
3. properties
4. contacts
5. activities
6. deals
7. cases
8. tags
9. tasks
10. goals
11. agent_cards
12. chat_messages

```sql
-- Template for each table (repeat 12 times)

-- 1. Add column
ALTER TABLE public.clients
  ADD COLUMN IF NOT EXISTS tenant_id UUID REFERENCES public.tenants(id);

-- 2. Backfill (join via profiles)
UPDATE public.clients c
SET tenant_id = p.tenant_id
FROM public.profiles p
WHERE c.org_id = p.id
AND c.tenant_id IS NULL;

-- 3. Add index
CREATE INDEX idx_clients_tenant ON public.clients(tenant_id)
WHERE tenant_id IS NOT NULL;

-- 4. Verify
SELECT COUNT(*) as clients_without_tenant
FROM clients
WHERE tenant_id IS NULL;
-- Should be 0 or very low (orphaned records)

-- Repeat for: orders, properties, contacts, activities, deals, cases, tags, tasks, goals, agent_cards, chat_messages
```

**Progress Tracking:**
```sql
-- Query to check progress
SELECT
  'clients' as table_name,
  COUNT(*) as total,
  COUNT(tenant_id) as with_tenant,
  COUNT(*) - COUNT(tenant_id) as without_tenant,
  ROUND(100.0 * COUNT(tenant_id) / COUNT(*), 2) as percent_complete
FROM clients
UNION ALL
SELECT 'orders', COUNT(*), COUNT(tenant_id), COUNT(*) - COUNT(tenant_id), ROUND(100.0 * COUNT(tenant_id) / COUNT(*), 2) FROM orders
UNION ALL
SELECT 'properties', COUNT(*), COUNT(tenant_id), COUNT(*) - COUNT(tenant_id), ROUND(100.0 * COUNT(tenant_id) / COUNT(*), 2) FROM properties;
-- ... repeat for all tables
```

---

### Step 5: Update RLS Policies (30 minutes)

**Pattern: Make policies ADDITIVE (support both old and new logic)**

```sql
-- Example: clients table

-- Drop existing policy
DROP POLICY IF EXISTS "Authenticated users can view clients" ON public.clients;

-- Create new policy (additive - supports both org_id and tenant_id)
CREATE POLICY "Users can view their clients"
  ON public.clients FOR SELECT
  USING (
    -- OLD LOGIC (backward compatible)
    org_id = auth.uid()
    OR
    -- NEW LOGIC (teams via tenant)
    tenant_id IN (
      SELECT tenant_id FROM public.profiles WHERE id = auth.uid()
    )
  );

-- Similarly update INSERT, UPDATE, DELETE policies
CREATE POLICY "Users can insert clients"
  ON public.clients FOR INSERT
  WITH CHECK (
    org_id = auth.uid()
    OR
    tenant_id IN (SELECT tenant_id FROM public.profiles WHERE id = auth.uid())
  );

CREATE POLICY "Users can update their clients"
  ON public.clients FOR UPDATE
  USING (
    org_id = auth.uid()
    OR
    tenant_id IN (SELECT tenant_id FROM public.profiles WHERE id = auth.uid())
  )
  WITH CHECK (
    org_id = auth.uid()
    OR
    tenant_id IN (SELECT tenant_id FROM public.profiles WHERE id = auth.uid())
  );

CREATE POLICY "Users can delete their clients"
  ON public.clients FOR DELETE
  USING (
    org_id = auth.uid()
    OR
    tenant_id IN (SELECT tenant_id FROM public.profiles WHERE id = auth.uid())
  );
```

**Tables with RLS policies to update:**
- profiles (2 policies)
- clients (4 policies: SELECT, INSERT, UPDATE, DELETE)
- orders (4 policies)
- properties (4 policies)
- contacts (4 policies)
- activities (4 policies)
- deals (4 policies)
- cases (4 policies)
- tags (4 policies)
- tasks (4 policies)
- goals (4 policies)
- agent_cards (4 policies)
- chat_messages (4 policies)

**Total:** ~40+ policies

---

### Step 6: Post-Migration Validation (30 minutes)

```sql
-- 1. Data integrity check
SELECT
  'tenants' as check_name,
  COUNT(*) as count,
  'All users have tenant' as description
FROM profiles p
LEFT JOIN tenants t ON p.tenant_id = t.id
WHERE t.id IS NULL;
-- count should be 0

-- 2. Backfill completeness
SELECT
  'clients_backfill' as check_name,
  COUNT(*) as count,
  'All clients have tenant_id' as description
FROM clients WHERE tenant_id IS NULL;
-- count should be 0 (or explained orphans)

-- 3. RLS policy test (run as test user)
-- Test 1: User can see their own data
-- Test 2: User cannot see other tenant's data

-- 4. Performance check
EXPLAIN ANALYZE
SELECT * FROM clients WHERE tenant_id = 'some-tenant-id';
-- Check query plan uses index
```

**Security Test:**
```typescript
// Test tenant isolation (manual test script)
// 1. Create two test users in different tenants
// 2. Create client as user A
// 3. Try to fetch as user B
// 4. Verify: B cannot see A's client

const userA = await createTestUser({ email: 'usera@tenant1.com' });
const userB = await createTestUser({ email: 'userb@tenant2.com' });

const clientA = await createClient(userA.auth, { name: 'Client A' });

const { data, error } = await supabase
  .from('clients')
  .select('*')
  .eq('id', clientA.id);

// Expected: data = null (RLS blocks access)
assert(data === null, 'Tenant isolation failed!');
```

---

### Step 7: Performance Monitoring (Ongoing)

```sql
-- Monitor query performance for 24 hours post-migration

-- Slow query log
SELECT
  query,
  mean_exec_time,
  calls
FROM pg_stat_statements
WHERE mean_exec_time > 1000 -- >1 second
ORDER BY mean_exec_time DESC
LIMIT 20;

-- If queries slow, add indexes:
CREATE INDEX CONCURRENTLY idx_table_tenant ON table_name(tenant_id);
```

---

## Rollback Procedure

**If critical issues discovered:**

```sql
-- EMERGENCY ROLLBACK

-- 1. Revert RLS policies (restore from backup)
-- Run: supabase db reset --db-url <backup-url>

-- OR manual revert:
DROP POLICY IF EXISTS "Users can view their clients" ON clients;
CREATE POLICY "Authenticated users can view clients"
  ON clients FOR SELECT TO authenticated USING (true);

-- 2. Remove tenant_id columns (data preserved in org_id)
ALTER TABLE clients DROP COLUMN IF EXISTS tenant_id;
ALTER TABLE orders DROP COLUMN IF EXISTS tenant_id;
-- ... repeat for all tables

-- 3. Drop tenants table
DROP TABLE IF EXISTS public.tenants CASCADE;

-- 4. Verify system functional
-- Run integration tests
```

**Decision Maker:** Tech lead must approve rollback

---

## Testing Checklist

### Pre-Deployment Tests (Staging)

- [ ] Migration script runs successfully on staging database
- [ ] All tables backfilled correctly (0 NULL tenant_id values)
- [ ] RLS policies functional (test user access)
- [ ] Tenant isolation verified (security test)
- [ ] Performance acceptable (queries <2x baseline)
- [ ] Rollback tested successfully

### Post-Deployment Tests (Production)

- [ ] All validation queries passing
- [ ] Security test (tenant isolation) passed
- [ ] Sample of existing features working:
  - [ ] User can login
  - [ ] User can view their clients
  - [ ] User can create new order
  - [ ] Dashboard loads correctly
- [ ] No error spikes in Sentry
- [ ] API response times within 2x baseline

---

## Success Criteria

- [ ] All existing users have `tenant_id` in profiles
- [ ] All 12 tables have `tenant_id` backfilled (0 NULLs)
- [ ] All RLS policies updated and functional
- [ ] Tenant isolation verified (user A cannot see tenant B data)
- [ ] Zero data loss
- [ ] All existing features working
- [ ] Performance degradation <100% (acceptable temporary overhead)
- [ ] Migration completes in <4 hours
- [ ] No rollback required

---

## Communication Plan

### Pre-Migration (48 hours before)

**Email to all users:**
```
Subject: Scheduled Maintenance - Nov 10, 2025 2-6 AM UTC

We will be performing a database migration to support team collaboration features.

Expected downtime: <1 hour
Scheduled window: Nov 10, 2-6 AM UTC (adjust for your timezone)

During this time:
- Login may be unavailable
- Dashboard access interrupted
- No data will be lost

We'll send an update when maintenance is complete.

Questions? Reply to this email.
```

### During Migration

**Status page updates every 30 minutes:**
- "Migration in progress - 25% complete"
- "Migration in progress - 50% complete"
- "Migration in progress - 75% complete"
- "Validation running..."

### Post-Migration

**Success email:**
```
Subject: Maintenance Complete ✅

Database migration completed successfully.

All systems operational.
No action required from you.

New feature available: Team collaboration (invite colleagues to your workspace)
Learn more: [link to docs]
```

**If issues:**
```
Subject: Maintenance Extended ⚠️

We encountered [issue description].

Current status: [investigating / rolling back / fixing]
Expected resolution: [timeframe]

We'll update you within 1 hour.
```

---

## Timeline

| Time (UTC) | Activity | Duration | Owner |
|------------|----------|----------|-------|
| **02:00** | Start maintenance window | - | DevOps |
| **02:00-02:30** | Pre-migration checks | 30 min | Backend Dev |
| **02:30-02:45** | Create tenants | 15 min | Backend Dev |
| **02:45-02:55** | Backfill profiles | 10 min | Backend Dev |
| **02:55-03:55** | Backfill 12 tables | 60 min | Backend Dev |
| **03:55-04:25** | Update RLS policies | 30 min | Backend Dev |
| **04:25-04:55** | Validation & testing | 30 min | QA |
| **04:55-05:30** | Performance monitoring | 35 min | DevOps |
| **05:30-06:00** | Buffer / rollback window | 30 min | Team |

**Total:** 4 hours (within maintenance window)

---

## Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|------------|------------|
| **Script fails mid-execution** | Critical | Low | Transaction-wrapped, rollback ready |
| **Backfill takes >2 hours** | High | Medium | Batch processing, progress monitoring |
| **Performance degrades >2x** | High | Medium | Indexes ready, query optimization planned |
| **Data inconsistency** | Critical | Low | Validation queries, manual spot checks |
| **Rollback fails** | Critical | Very Low | Rollback tested on staging, backup verified |

---

## Post-Migration Tasks

**Within 24 hours:**
- [ ] Monitor error rates (Sentry)
- [ ] Monitor query performance
- [ ] Verify no user-reported issues
- [ ] Document actual vs. estimated times
- [ ] Post-mortem meeting (what went well, what didn't)

**Within 1 week:**
- [ ] Performance tuning (add indexes if needed)
- [ ] Update documentation with lessons learned
- [ ] Archive migration scripts (version control)

---

## Sign-Off

**Before execution:**
- [ ] Backend Developer: Migration plan reviewed ________________
- [ ] DevOps: Infrastructure ready ________________
- [ ] Tech Lead: Approval granted ________________
- [ ] Product Owner: Business continuity approved ________________

**After execution:**
- [ ] Migration completed successfully: Yes / No
- [ ] Rollback required: Yes / No
- [ ] Post-migration validation: Pass / Fail
- [ ] Production ready: Yes / No

---

**Task Status:** ⏳ Ready for execution (pending stakeholder approval)
**Next Task:** [0.3 Validation & Monitoring](./0.3-validation-monitoring.md)
