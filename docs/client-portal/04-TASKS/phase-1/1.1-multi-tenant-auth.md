# Task 1.1: Multi-Tenant Authentication

**Phase:** 1 (MVP)
**Priority:** P0 (Critical)
**Effort:** 8 story points (~1.5 weeks)
**Owner:** Backend Developer + Frontend Developer

---

## References

**Requirements:** [FR-1: Multi-Tenant Authentication](../../01-REQUIREMENTS.md#fr-1)
**Architecture:**
- [Service-Role Usage](../../02-ARCHITECTURE.md#service-role-usage)
- [RLS Policy Design](../../02-ARCHITECTURE.md#rls-policy-design)
**Roadmap:** [Phase 1.1](../../03-ROADMAP.md#11-enhanced-authentication)

---

## Objective

Implement enhanced authentication supporting:
- User registration with tenant creation/selection
- Email verification
- Password reset
- Optional MFA (TOTP)
- Secure service-role usage for tenant creation

**All requirements detailed in:** [FR-1](../../01-REQUIREMENTS.md#fr-1)

---

## Prerequisites

- [ ] Phase 0 (Multi-Tenant Migration) complete
- [ ] `tenants` table exists with RLS policies
- [ ] `SUPABASE_SERVICE_ROLE_KEY` environment variable set
- [ ] Email service configured (Supabase SMTP or SendGrid)

---

## Implementation

### 1. Service-Role Client Setup

**File:** `src/lib/supabase/admin.ts`

**Purpose:** Safely wrap service-role operations with logging (see [Architecture: Service-Role Usage](../../02-ARCHITECTURE.md#service-role-usage))

```typescript
import { createClient } from '@supabase/supabase-js';
import { createClient as createRegularClient } from './server';

// NEVER export admin client directly
function getAdminClient() {
  if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
    throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');
  }

  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY,
    { auth: { persistSession: false } }
  );
}

// Safe wrapper with audit logging
export async function executeAsAdmin<T>(
  operation: string,
  userId: string,
  fn: (adminClient: any) => Promise<T>
): Promise<T> {
  // 1. Verify user is authenticated
  const supabase = createRegularClient();
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user || user.id !== userId) {
    throw new Error('Unauthorized admin operation');
  }

  // 2. Log operation (sent to Vercel logs + Sentry)
  console.log('[ADMIN OPERATION]', {
    operation,
    userId,
    timestamp: new Date().toISOString()
  });

  // 3. Execute
  const adminClient = getAdminClient();
  const result = await fn(adminClient);

  // 4. Log completion
  console.log('[ADMIN OPERATION COMPLETE]', { operation, userId });

  return result;
}
```

**Testing:**
```typescript
// Test: executeAsAdmin rejects unauthenticated calls
it('should reject unauthenticated admin operation', async () => {
  await expect(
    executeAsAdmin('test', 'invalid-user-id', async () => {})
  ).rejects.toThrow('Unauthorized');
});
```

---

### 2. Validation Schemas

**File:** `src/lib/validations/auth.ts`

**Requirements:** [FR-1.1](../../01-REQUIREMENTS.md#fr-11-user-registration)

```typescript
import { z } from 'zod';

export const registerSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain uppercase letter')
    .regex(/[0-9]/, 'Password must contain a number'),
  name: z.string().min(2, 'Name must be at least 2 characters'),
  tenantName: z.string().min(2, 'Company name required'),
  tenantType: z.enum([
    'lender',
    'investor',
    'amc',
    'attorney',
    'accountant',
    'internal',
  ]),
});

export const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1),
});

export const resetPasswordSchema = z.object({
  email: z.string().email(),
});

export const mfaSetupSchema = z.object({
  code: z.string().length(6, 'Code must be 6 digits'),
});

export type RegisterInput = z.infer<typeof registerSchema>;
export type LoginInput = z.infer<typeof loginSchema>;
export type ResetPasswordInput = z.infer<typeof resetPasswordSchema>;
export type MFASetupInput = z.infer<typeof mfaSetupSchema>;
```

**Testing:** See [Testing Requirements](#testing-requirements) below

---

### 3. Registration API Route

**File:** `src/app/api/auth/register/route.ts`

**Requirements:** [FR-1.1](../../01-REQUIREMENTS.md#fr-11-user-registration)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { executeAsAdmin } from '@/lib/supabase/admin';
import { registerSchema } from '@/lib/validations/auth';
import { z } from 'zod';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, password, name, tenantName, tenantType } = registerSchema.parse(body);

    const supabase = createClient();

    // 1. Create user with Supabase Auth
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { name },
        emailRedirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback`,
      },
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error('User creation failed');

    const userId = authData.user.id;

    // 2. Create tenant (requires service-role)
    const tenant = await executeAsAdmin(
      'create_tenant_during_registration',
      userId,
      async (adminClient) => {
        const { data, error } = await adminClient
          .from('tenants')
          .insert({
            name: tenantName,
            type: tenantType,
            owner_id: userId,
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      }
    );

    // 3. Link user to tenant (requires service-role)
    await executeAsAdmin(
      'link_user_to_tenant',
      userId,
      async (adminClient) => {
        const { error } = await adminClient
          .from('profiles')
          .update({
            tenant_id: tenant.id,
            tenant_type: tenantType,
          })
          .eq('id', userId);

        if (error) throw error;
      }
    );

    return NextResponse.json({
      message: 'Registration successful. Please check your email to verify your account.',
      userId,
      tenantId: tenant.id,
    });

  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ errors: error.errors }, { status: 400 });
    }

    console.error('[Registration Error]', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Registration failed' },
      { status: 500 }
    );
  }
}
```

---

### 4. MFA Setup API Route

**File:** `src/app/api/auth/mfa/setup/route.ts`

**Requirements:** [FR-1.4](../../01-REQUIREMENTS.md#fr-14-multi-factor-authentication-mfa)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const supabase = createClient();

    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Enroll MFA
    const { data, error } = await supabase.auth.mfa.enroll({
      factorType: 'totp',
      friendlyName: 'Authenticator App',
    });

    if (error) throw error;

    return NextResponse.json({
      qrCode: data.totp.qr_code,
      secret: data.totp.secret,
      factorId: data.id,
    });

  } catch (error) {
    console.error('[MFA Setup Error]', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'MFA setup failed' },
      { status: 500 }
    );
  }
}
```

**File:** `src/app/api/auth/mfa/verify/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { mfaSetupSchema } from '@/lib/validations/auth';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { code } = mfaSetupSchema.parse(body);
    const { factorId } = body;

    const supabase = createClient();

    // Challenge
    const { data: challengeData, error: challengeError } = await supabase.auth.mfa.challenge({
      factorId,
    });

    if (challengeError) throw challengeError;

    // Verify
    const { error: verifyError } = await supabase.auth.mfa.verify({
      factorId,
      challengeId: challengeData.id,
      code,
    });

    if (verifyError) throw verifyError;

    return NextResponse.json({ success: true });

  } catch (error) {
    console.error('[MFA Verify Error]', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Verification failed' },
      { status: 500 }
    );
  }
}
```

---

### 5. Frontend Components

**File:** `src/components/auth/RegisterForm.tsx`

(Implementation similar to original plan, referencing validation schemas)

**File:** `src/components/auth/MFASetup.tsx`

(Implementation similar to original plan)

**Note:** Full component code available in original task stubs. Reference those for complete implementation.

---

## Testing Requirements

**Reference:** [01-REQUIREMENTS.md#testing](../../01-REQUIREMENTS.md#testing)

### Unit Tests

**File:** `src/lib/validations/__tests__/auth.test.ts`

```typescript
import { describe, it, expect } from '@jest/globals';
import { registerSchema, mfaSetupSchema } from '../auth';

describe('registerSchema', () => {
  it('accepts valid registration data', () => {
    const result = registerSchema.safeParse({
      email: 'test@example.com',
      password: 'Password123',
      name: 'John Doe',
      tenantName: 'Acme Corp',
      tenantType: 'lender',
    });
    expect(result.success).toBe(true);
  });

  it('rejects weak password', () => {
    const result = registerSchema.safeParse({
      email: 'test@example.com',
      password: 'weak', // No uppercase, no number
      name: 'John Doe',
      tenantName: 'Acme Corp',
      tenantType: 'lender',
    });
    expect(result.success).toBe(false);
  });

  it('rejects invalid email', () => {
    const result = registerSchema.safeParse({
      email: 'not-an-email',
      password: 'Password123',
      name: 'John Doe',
      tenantName: 'Acme Corp',
      tenantType: 'lender',
    });
    expect(result.success).toBe(false);
  });

  // ... more tests (10+ total)
});
```

**Coverage Target:** 80%+ (all validation paths)

### Integration Tests

**File:** `src/app/api/auth/__tests__/register.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';
import { POST } from '../register/route';
import { createMockRequest, cleanupTestData } from '@/test/utils';

describe('POST /api/auth/register', () => {
  afterEach(async () => {
    await cleanupTestData();
  });

  it('creates tenant and user successfully', async () => {
    const requestData = {
      email: 'test@example.com',
      password: 'Password123',
      name: 'John Doe',
      tenantName: 'Acme Lending',
      tenantType: 'lender',
    };

    const request = createMockRequest(requestData);
    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.userId).toBeDefined();
    expect(data.tenantId).toBeDefined();
    expect(data.message).toContain('email');
  });

  it('rejects duplicate email', async () => {
    // First registration
    const requestData = {
      email: 'duplicate@example.com',
      password: 'Password123',
      name: 'John Doe',
      tenantName: 'Acme Lending',
      tenantType: 'lender',
    };

    await POST(createMockRequest(requestData));

    // Attempt duplicate
    const response = await POST(createMockRequest(requestData));
    expect(response.status).toBe(500);
  });

  it('validates password requirements', async () => {
    const requestData = {
      email: 'test@example.com',
      password: 'weak',
      name: 'John Doe',
      tenantName: 'Acme Lending',
      tenantType: 'lender',
    };

    const response = await POST(createMockRequest(requestData));
    const data = await response.json();

    expect(response.status).toBe(400);
    expect(data.errors).toBeDefined();
  });

  // ... more tests (15+ total)
});
```

### E2E Tests

**File:** `e2e/auth/registration.spec.ts` (Playwright)

```typescript
import { test, expect } from '@playwright/test';

test.describe('User Registration Flow', () => {
  test('completes full registration with email verification', async ({ page }) => {
    // Navigate to registration
    await page.goto('/login');
    await page.click('text=Sign Up');

    // Fill form
    await page.fill('input[name="name"]', 'John Doe');
    await page.fill('input[name="email"]', `test-${Date.now()}@example.com`);
    await page.fill('input[name="password"]', 'Password123');
    await page.fill('input[name="tenantName"]', 'Acme Lending');
    await page.selectOption('select[name="tenantType"]', 'lender');

    // Submit
    await page.click('button[type="submit"]');

    // Wait for success message
    await expect(page.locator('text=check your email')).toBeVisible();
  });

  test('displays validation errors', async ({ page }) => {
    await page.goto('/login?mode=signup');

    // Submit empty form
    await page.click('button[type="submit"]');

    // Check for errors
    await expect(page.locator('text=Invalid email')).toBeVisible();
    await expect(page.locator('text=at least 8 characters')).toBeVisible();
  });

  // ... more tests (5+ total)
});

test.describe('MFA Enrollment', () => {
  test('enables 2FA successfully', async ({ page, context }) => {
    // Login first
    await page.goto('/login');
    await page.fill('input[name="email"]', 'existing@example.com');
    await page.fill('input[name="password"]', 'Password123');
    await page.click('button[type="submit"]');

    // Navigate to security settings
    await page.goto('/settings/security');

    // Enable 2FA
    await page.click('text=Enable 2FA');

    // Wait for QR code
    await expect(page.locator('img[alt*="QR"]')).toBeVisible();

    // Enter code (mock authenticator: 123456)
    await page.fill('input[name="code"]', '123456');
    await page.click('button:has-text("Verify")');

    // Check success
    await expect(page.locator('text=enabled successfully')).toBeVisible();
  });

  // ... more tests (3+ total)
});
```

### Security Tests

**File:** `src/__tests__/security/service-role-usage.test.ts`

```typescript
import { describe, it, expect } from '@jest/globals';
import { executeAsAdmin } from '@/lib/supabase/admin';

describe('Service-Role Security', () => {
  it('rejects unauthenticated admin operations', async () => {
    await expect(
      executeAsAdmin('test', 'fake-user-id', async () => {})
    ).rejects.toThrow('Unauthorized');
  });

  it('logs all admin operations', async () => {
    const consoleSpy = jest.spyOn(console, 'log');

    // Perform admin operation (with valid auth)
    // ... test setup ...

    expect(consoleSpy).toHaveBeenCalledWith(
      expect.stringContaining('[ADMIN OPERATION]'),
      expect.objectContaining({ operation: 'test' })
    );
  });

  // ... more tests
});
```

---

## Acceptance Criteria

**From:** [FR-1 Acceptance Criteria](../../01-REQUIREMENTS.md#fr-1)

- [ ] User can complete registration flow end-to-end
- [ ] Email verification link works and activates account
- [ ] Login with correct credentials succeeds
- [ ] Login with incorrect credentials fails with clear error
- [ ] Password reset email arrives within 2 minutes
- [ ] MFA enrollment generates working QR code
- [ ] MFA login requires both password and code
- [ ] All validation errors display user-friendly messages
- [ ] Service-role operations logged to Sentry
- [ ] Test coverage ≥80%

---

## Implementation Checklist

### Backend
- [ ] Create `src/lib/supabase/admin.ts` with `executeAsAdmin`
- [ ] Create `src/lib/validations/auth.ts` schemas
- [ ] Implement `POST /api/auth/register`
- [ ] Implement `POST /api/auth/mfa/setup`
- [ ] Implement `POST /api/auth/mfa/verify`
- [ ] Implement `POST /api/auth/reset-password`
- [ ] Add error handling and logging

### Frontend
- [ ] Create `RegisterForm.tsx` component
- [ ] Create `MFASetup.tsx` component
- [ ] Update `/app/login/page.tsx` with registration mode
- [ ] Add form validation feedback
- [ ] Add loading states

### Testing
- [ ] Write unit tests for validation schemas (10+ tests)
- [ ] Write integration tests for API routes (15+ tests)
- [ ] Write E2E tests for registration flow (5+ tests)
- [ ] Write E2E tests for MFA setup (3+ tests)
- [ ] Write security tests for service-role usage (5+ tests)
- [ ] Achieve 80%+ code coverage

### Documentation
- [ ] Document API endpoints in OpenAPI spec
- [ ] Create user guide for registration
- [ ] Document service-role usage pattern
- [ ] Add inline code comments

---

## Timeline

| Day | Activity | Owner |
|-----|----------|-------|
| **1-2** | Service-role wrapper, validation schemas | Backend Dev |
| **3-4** | Registration API route, testing | Backend Dev |
| **5-6** | MFA API routes, testing | Backend Dev |
| **7-8** | Frontend components (RegisterForm, MFASetup) | Frontend Dev |
| **9** | E2E tests, integration | QA |
| **10** | Bug fixes, code review | Team |

---

## Deployment

**Environment Variables Required:**
```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc... # CRITICAL: Server-side only
NEXT_PUBLIC_APP_URL=https://app.salesmod.com
```

**Pre-Deployment Checklist:**
- [ ] All tests passing in CI
- [ ] Security scan clean (no service-role key leaks)
- [ ] Staging deployment tested
- [ ] Sentry configured for error logging
- [ ] Email service tested (verification emails sending)

---

## Monitoring

**Metrics to Track:**
- Registration success rate (target: >95%)
- Email verification rate (target: >80% within 24 hours)
- MFA enrollment rate (optional, tracking for insights)
- Service-role operation frequency (should be low, only on registration)
- API error rate (target: <1%)

**Alerts:**
- Registration failures >5% → Slack alert
- Service-role errors → PagerDuty (critical)
- Email delivery failures → Email to ops team

---

## Next Task

**After Task 1.1 Complete:**
- [Task 1.2: Client Dashboard](./1.2-client-dashboard.md)

---

**Task Status:** ⏳ Ready for implementation
**Estimated Completion:** Week 2 of Phase 1
