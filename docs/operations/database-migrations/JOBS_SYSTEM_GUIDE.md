# Jobs System - Quick Reference Guide

## Overview

The Jobs System provides a campaign runner for multi-step AI agent workflows. It orchestrates email campaigns, follow-ups, and other tasks across multiple contacts with full tracking and metrics.

---

## ğŸ“Š Database Schema

### Core Tables

#### `jobs` - Campaign Container
Main table for tracking campaigns/projects:
- **Status Flow**: `pending` â†’ `running` â†’ `succeeded`/`failed`/`cancelled`
- **Metrics**: Denormalized counters for fast dashboard access
- **Params**: JSONB configuration for targets, templates, cadence, etc.

#### `job_tasks` - Execution Steps
Granular tasks within a job:
- **Types**: `draft_email`, `send_email`, `create_task`, `schedule_call`, `check_portal`, `update_profile`, `research`, `follow_up`, `create_deal`
- **Batch Support**: Incremental planning (batch 0 = initial, 1+ = generated by runner)
- **Retry Logic**: Built-in retry counter and error tracking

#### `job_metrics` - Materialized View
Fast analytics and reporting:
- Task completion rates
- Card state breakdowns
- Email metrics
- Execution timing
- Organization-level rollups

### Integration Points

- **`kanban_cards.job_id`** - Links cards to jobs
- **`kanban_cards.task_id`** - Links cards to specific tasks (1:many)
- **`agent_runs.job_id`** - Tracks which run processed which job

---

## ğŸš€ Usage Examples

### 1. Creating a Job

```sql
-- Create a new email campaign job
INSERT INTO jobs (org_id, name, description, params)
VALUES (
  auth.uid(),
  'Q4 AMC Follow-up Campaign',
  'Multi-touch email campaign for AMC clients in Florida',
  jsonb_build_object(
    'target_group', 'AMC',
    'target_filter', jsonb_build_object('state', 'FL', 'active', true),
    'cadence', jsonb_build_object('day0', true, 'day4', true, 'day10', true),
    'templates', jsonb_build_object(
      'intro', 'Subject: Partnership Update\nBody: Hello {{first_name}}...',
      'followup1', 'Subject: Following Up\nBody: ...',
      'followup2', 'Subject: Final Reminder\nBody: ...'
    ),
    'review_mode', true,
    'batch_size', 10
  )
)
RETURNING id;
```

### 2. Adding Tasks to a Job

```sql
-- Add initial tasks (batch 0)
INSERT INTO job_tasks (job_id, step, batch, kind, input)
VALUES
  (
    '{{job_id}}',
    1,
    0,
    'draft_email',
    jsonb_build_object(
      'target_type', 'contact_group',
      'contact_ids', ARRAY['uuid1', 'uuid2', 'uuid3'],
      'template', 'intro',
      'variables', jsonb_build_object('company_name', 'Our Company')
    )
  ),
  (
    '{{job_id}}',
    2,
    0,
    'send_email',
    jsonb_build_object(
      'wait_for_approval', true,
      'scheduled_for', NOW() + INTERVAL '1 hour'
    )
  );
```

### 3. Starting a Job

```sql
-- Transition job to running state
SELECT transition_job_status('{{job_id}}', 'running');
```

### 4. Linking Cards to Jobs

```sql
-- When creating cards from a job task
INSERT INTO kanban_cards (
  org_id,
  job_id,
  task_id,
  type,
  title,
  state,
  content
)
VALUES (
  auth.uid(),
  '{{job_id}}',
  {{task_id}},
  'send_email',
  'Email: {{contact_name}} - Intro',
  'in_review',
  jsonb_build_object(
    'to', 'contact@example.com',
    'subject', 'Partnership Update',
    'body', '...'
  )
);
```

### 5. Querying Job Progress

```sql
-- Get all cards for a job
SELECT * FROM get_job_cards('{{job_id}}');

-- Get detailed progress
SELECT * FROM get_job_progress('{{job_id}}');

-- Get job metrics (fast - uses materialized view)
SELECT * FROM job_metrics WHERE job_id = '{{job_id}}';

-- Get organization performance summary
SELECT * FROM job_performance_summary WHERE org_id = auth.uid();

-- Recent activity across all jobs
SELECT * FROM recent_job_activity WHERE org_id = auth.uid() LIMIT 10;
```

### 6. Handling Errors & Retries

```sql
-- Mark a task as failed with error
UPDATE job_tasks
SET
  status = 'error',
  error_message = 'API timeout',
  retry_count = retry_count + 1,
  finished_at = NOW()
WHERE id = {{task_id}};

-- Retry a failed task
UPDATE job_tasks
SET
  status = 'pending',
  started_at = NULL,
  finished_at = NULL
WHERE id = {{task_id}} AND status = 'error';
```

### 7. Cancelling a Job

```sql
-- Cancel job and skip all pending/running tasks
SELECT cancel_job('{{job_id}}');
```

---

## ğŸ”’ Security (RLS Policies)

All tables use Row-Level Security:

- **Jobs**: Users can only access jobs where `org_id = auth.uid()`
- **Job Tasks**: Access controlled via parent job ownership
- **Functions**: Use `SECURITY DEFINER` with ownership checks

---

## ğŸ“ˆ Automatic Metrics

Metrics update automatically via triggers when:

1. **Task status changes** â†’ Updates job task counters
2. **Card state changes** â†’ Updates job card metrics
3. **Cards created/deleted** â†’ Recalculates totals

To manually refresh the materialized view:

```sql
SELECT refresh_job_metrics();
```

---

## ğŸ¯ Typical Workflow

```
1. CREATE JOB
   â†“
2. GENERATE INITIAL TASKS (batch 0)
   â†“
3. START JOB (status: running)
   â†“
4. AGENT PROCESSES TASKS
   â”œâ”€> Creates kanban_cards (state: in_review)
   â”œâ”€> Links cards to job_id & task_id
   â””â”€> Updates task status (done/error)
   â†“
5. USER REVIEWS CARDS
   â”œâ”€> Approves: state â†’ approved
   â””â”€> Rejects: state â†’ rejected
   â†“
6. AGENT EXECUTES APPROVED CARDS
   â”œâ”€> Sends emails
   â”œâ”€> Creates follow-up tasks
   â””â”€> state â†’ done
   â†“
7. AGENT GENERATES NEXT BATCH (batch 1+)
   â””â”€> Follow-up tasks based on results
   â†“
8. REPEAT 4-7 UNTIL COMPLETE
   â†“
9. JOB COMPLETES (status: succeeded/failed)
```

---

## ğŸ“ Task Types

| Type | Description | Example Input |
|------|-------------|---------------|
| `draft_email` | Create email content | `{contact_ids, template, variables}` |
| `send_email` | Send drafted email | `{card_id, scheduled_for}` |
| `create_task` | Create follow-up task | `{contact_id, type, due_date}` |
| `schedule_call` | Schedule a call | `{contact_id, datetime, duration}` |
| `check_portal` | Verify portal access | `{client_id}` |
| `update_profile` | Update contact info | `{contact_id, fields}` |
| `research` | Research client/property | `{target_id, research_type}` |
| `follow_up` | Log follow-up activity | `{contact_id, notes}` |
| `create_deal` | Create deal record | `{contact_id, amount, stage}` |

---

## ğŸ”§ Helper Functions

### Status Management
- `transition_job_status(job_id, new_status)` - Safely transition states
- `cancel_job(job_id)` - Cancel job and skip pending tasks

### Queries
- `get_job_cards(job_id)` - Get all cards for a job
- `get_job_progress(job_id)` - Get job progress summary
- `get_job_metrics_for_org(org_id)` - Get metrics for organization
- `refresh_job_metrics()` - Refresh materialized view

---

## ğŸ’¡ Current State

**Database Connection**: Session Pooler
**Tables Created**: âœ… jobs, job_tasks
**Links Established**: âœ… kanban_cards.job_id, agent_runs.job_id
**Views**: âœ… job_metrics, job_performance_summary, recent_job_activity
**Functions**: âœ… 11 helper functions
**RLS**: âœ… Enabled on all tables

**Existing Data**:
- 7 kanban_cards (0 linked to jobs)
- 5 agent_runs (0 linked to jobs)
- 0 jobs (ready for first campaign!)

---

## ğŸ‰ Next Steps

1. **Create your first job** using the campaign parameters
2. **Link existing cards** to jobs by adding `job_id` (optional)
3. **Update agent runner** to process job_tasks
4. **Add job UI** to dashboard for monitoring
5. **Set up metrics refresh** (cron job or trigger-based)

The system is ready to orchestrate multi-step campaigns! ğŸš€



