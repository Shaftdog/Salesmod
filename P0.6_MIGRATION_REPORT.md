# P0.6 Agent Kill Switch Migration Report

**Date:** 2025-12-17
**Status:** ✅ Successfully Applied
**Migration:** `20251217100000_agent_kill_switch.sql`

## Summary

Successfully applied the P0.6 agent kill switch and rate limiting infrastructure to the Supabase database. This migration adds critical safety controls for the autonomous agent system.

## What Was Created

### 1. Tables

#### `system_config`
Global system configuration table with agent kill switch:
- Stores global agent settings including `global_enabled` flag
- Contains kill switch metadata (reason, activated_at, activated_by)
- Configured with default values: agent enabled globally

#### `agent_rate_limits`
Centralized rate limiting tracking:
- Tracks action counts per tenant per time window
- Columns: tenant_id, action_type, window_start, action_count, max_allowed
- Supports multiple rate limit types (email_send, research, sandbox_run, etc.)
- Includes RLS policies for security

### 2. Columns Added to `tenants`

- `agent_enabled` (BOOLEAN, default: true) - Per-tenant agent on/off switch
- `agent_settings` (JSONB) - Per-tenant configuration including:
  - enabled status
  - disabled_reason, disabled_at, disabled_by
  - max_actions_per_cycle
  - max_emails_per_hour
  - max_research_per_hour
  - allowed_action_types array

### 3. Database Functions

#### Kill Switch Management
- `is_agent_globally_enabled()` - Check global kill switch status
- `is_agent_enabled_for_tenant(tenant_id)` - Check if agent enabled for specific tenant
- `activate_agent_kill_switch(reason, activated_by)` - Emergency stop all agents
- `deactivate_agent_kill_switch(deactivated_by)` - Resume agent operations

#### Per-Tenant Controls
- `disable_agent_for_tenant(tenant_id, reason, disabled_by)` - Disable agent for one tenant
- `enable_agent_for_tenant(tenant_id, enabled_by)` - Re-enable agent for one tenant

#### Rate Limiting
- `check_and_increment_rate_limit(tenant_id, action_type, max_allowed)` - Check/increment rate limit
  - Returns TRUE if action allowed
  - Returns FALSE if rate limited
  - Uses row-level locking to prevent race conditions
  - Checks limit BEFORE incrementing (prevents off-by-one errors)
- `get_rate_limit_status(tenant_id)` - Get current rate limit status for monitoring
- `cleanup_old_rate_limits()` - Cleanup function for old records (>24 hours)

### 4. Indexes

- `idx_tenants_agent_enabled` - Fast filtering for active tenants with agent enabled
- `idx_rate_limits_tenant_type` - Rate limit lookups by tenant and action type
- `idx_rate_limits_cleanup` - Cleanup query optimization

### 5. Security (RLS Policies)

- `service_role_full_access` - Service role can read/write all rate limits
- `admin_read_only` - Admins can view rate limits for their tenant
- Regular users cannot access rate limit data

## Migration Issues Fixed

### Original Issue
The migration initially failed with:
```
ERROR: functions in index predicate must be marked IMMUTABLE
```

This was caused by line 83 using `NOW()` in an index WHERE clause:
```sql
CREATE INDEX ... WHERE window_start < NOW() - INTERVAL '24 hours';
```

### Resolution
Removed the WHERE clause with `NOW()` since it's not immutable:
```sql
CREATE INDEX idx_rate_limits_cleanup ON agent_rate_limits(window_start);
```

The cleanup is now handled by the `cleanup_old_rate_limits()` function instead of being filtered at index creation.

## Verification Results

All required objects were successfully created:

```
✅ system_config table exists
✅ agent_config entry exists with default values
✅ tenants.agent_enabled column exists
✅ tenants.agent_settings column exists
✅ agent_rate_limits table exists (9 columns)
✅ All 9 functions created successfully
✅ All 5 indexes created successfully
✅ RLS policies applied
```

## Default Configuration

The system is now configured with safe defaults:

```json
{
  "global_enabled": true,
  "kill_switch_reason": null,
  "default_tenant_enabled": true,
  "max_concurrent_tenants": 10,
  "kill_switch_activated_at": null,
  "kill_switch_activated_by": null
}
```

## Integration Points

The autonomous agent system should now check:

1. **Before starting agent cycle:**
   ```typescript
   const isEnabled = await isAgentEnabledForTenant(tenantId);
   if (!isEnabled) {
     // Skip this tenant
     return;
   }
   ```

2. **Before each action:**
   ```typescript
   const canProceed = await checkAndIncrementRateLimit(
     tenantId,
     'email_send',
     maxEmailsPerHour
   );
   if (!canProceed) {
     // Rate limited, skip action
     return;
   }
   ```

3. **Emergency shutdown:**
   ```typescript
   await activateAgentKillSwitch(
     'Critical bug detected in agent logic',
     'system-monitor'
   );
   ```

## Next Steps

1. Update agent orchestrator to call kill switch checks
2. Update agent executor to call rate limit checks
3. Create admin UI for kill switch controls
4. Set up monitoring/alerting for rate limit thresholds
5. Implement periodic cleanup job for old rate limit records

## Files Modified

- `/Users/sherrardhaugabrooks/Documents/Salesmod/supabase/migrations/20251217100000_agent_kill_switch.sql` (fixed immutability issue)

## Files Created

- `/Users/sherrardhaugabrooks/Documents/Salesmod/scripts/verify-agent-kill-switch.js` (verification script)

## Migration Applied

```
✅ 20251217100000_agent_kill_switch.sql (applied: 2025-12-17 19:08:07)
```

---

**Status:** Ready for integration testing
**Documentation:** See migration file for detailed comments
